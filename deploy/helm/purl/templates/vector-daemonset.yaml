{{- if .Values.vector.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "purl.fullname" . }}-vector
  labels:
    {{- include "purl.labels" . | nindent 4 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "purl.fullname" . }}-vector
rules:
  - apiGroups: [""]
    resources: ["namespaces", "pods", "nodes"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "purl.fullname" . }}-vector
subjects:
  - kind: ServiceAccount
    name: {{ include "purl.fullname" . }}-vector
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: {{ include "purl.fullname" . }}-vector
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "purl.fullname" . }}-vector
  labels:
    {{- include "purl.labels" . | nindent 4 }}
data:
  vector.yaml: |
    sources:
      kubernetes_logs:
        type: kubernetes_logs
        {{- if .Values.vector.excludeNamespaces }}
        extra_label_selector: "app!=vector"
        {{- end }}

    transforms:
      k8s_parsed:
        type: remap
        inputs:
          - kubernetes_logs
        source: |
          .service = .kubernetes.pod_labels."app.kubernetes.io/name" ??
                     .kubernetes.pod_labels.app ??
                     .kubernetes.container_name ??
                     "unknown"
          .host = .kubernetes.pod_name

          parsed, err = parse_json(.message)
          if err == null {
            .level = parsed.level ?? parsed.lvl ?? parsed.severity ?? "INFO"
            .message = parsed.msg ?? parsed.message ?? parsed.text ?? .message
            .meta = {
              "namespace": .kubernetes.pod_namespace,
              "pod": .kubernetes.pod_name,
              "container": .kubernetes.container_name,
              "node": .kubernetes.pod_node_name
            }
          } else {
            if contains(string!(.message), "ERROR") || contains(string!(.message), "error") {
              .level = "ERROR"
            } else if contains(string!(.message), "WARN") || contains(string!(.message), "warn") {
              .level = "WARN"
            } else if contains(string!(.message), "DEBUG") || contains(string!(.message), "debug") {
              .level = "DEBUG"
            } else {
              .level = "INFO"
            }
            .meta = {
              "namespace": .kubernetes.pod_namespace,
              "pod": .kubernetes.pod_name,
              "container": .kubernetes.container_name
            }
          }

          .level = upcase(string!(.level))
          .raw = .message
          del(.kubernetes)
          del(.file)
          del(.source_type)
          del(.stream)

    sinks:
      purl:
        type: http
        inputs:
          - k8s_parsed
        uri: "http://{{ include "purl.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.purl.service.port }}/api/logs"
        encoding:
          codec: json
        batch:
          max_bytes: 1048576
          max_events: 100
          timeout_secs: 5
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "purl.fullname" . }}-vector
  labels:
    {{- include "purl.labels" . | nindent 4 }}
    app.kubernetes.io/component: vector
spec:
  selector:
    matchLabels:
      {{- include "purl.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: vector
  template:
    metadata:
      labels:
        {{- include "purl.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: vector
    spec:
      serviceAccountName: {{ include "purl.fullname" . }}-vector
      containers:
        - name: vector
          image: "{{ .Values.vector.image.repository }}:{{ .Values.vector.image.tag }}"
          args:
            - --config-yaml
            - /etc/vector/vector.yaml
          volumeMounts:
            - name: config
              mountPath: /etc/vector
              readOnly: true
            - name: var-log
              mountPath: /var/log
              readOnly: true
            - name: var-lib-docker
              mountPath: /var/lib/docker
              readOnly: true
            - name: data
              mountPath: /var/lib/vector
          resources:
            {{- toYaml .Values.vector.resources | nindent 12 }}
      volumes:
        - name: config
          configMap:
            name: {{ include "purl.fullname" . }}-vector
        - name: var-log
          hostPath:
            path: /var/log
        - name: var-lib-docker
          hostPath:
            path: /var/lib/docker
        - name: data
          hostPath:
            path: /var/lib/vector
      tolerations:
        - operator: Exists
{{- end }}
