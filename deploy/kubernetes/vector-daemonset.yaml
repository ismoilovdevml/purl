---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: purl
data:
  vector.toml: |
    [sources.kubernetes_logs]
    type = "kubernetes_logs"

    [transforms.enrich]
    type = "remap"
    inputs = ["kubernetes_logs"]
    source = '''
    .service = .kubernetes.pod_name
    .host = .kubernetes.node_name

    # Level detection
    msg = string!(.message)
    if contains(msg, "ERROR") || contains(msg, "error") {
        .level = "ERROR"
    } else if contains(msg, "WARN") || contains(msg, "warn") {
        .level = "WARNING"
    } else if contains(msg, "DEBUG") || contains(msg, "debug") {
        .level = "DEBUG"
    } else {
        .level = "INFO"
    }

    .raw = msg
    .meta = {
        "namespace": .kubernetes.namespace,
        "pod": .kubernetes.pod_name,
        "container": .kubernetes.container_name,
    }

    del(.kubernetes)
    del(.file)
    '''

    [sinks.purl]
    type = "http"
    inputs = ["enrich"]
    uri = "http://purl.purl.svc.cluster.local:3000/api/logs"
    method = "post"
    encoding.codec = "json"
    batch.max_events = 100
    batch.timeout_secs = 5

    [sinks.purl.request]
    headers.X-API-Key = "${PURL_API_KEY}"
    headers.Content-Type = "application/json"

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: vector
  namespace: purl
spec:
  selector:
    matchLabels:
      app: vector
  template:
    metadata:
      labels:
        app: vector
    spec:
      serviceAccountName: vector
      containers:
        - name: vector
          image: timberio/vector:0.51.1-alpine
          env:
            - name: PURL_API_KEY
              valueFrom:
                secretKeyRef:
                  name: purl-secret
                  key: api-key
          volumeMounts:
            - name: config
              mountPath: /etc/vector/vector.toml
              subPath: vector.toml
            - name: var-log
              mountPath: /var/log
              readOnly: true
            - name: var-lib-docker
              mountPath: /var/lib/docker/containers
              readOnly: true
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
      volumes:
        - name: config
          configMap:
            name: vector-config
        - name: var-log
          hostPath:
            path: /var/log
        - name: var-lib-docker
          hostPath:
            path: /var/lib/docker/containers

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vector
  namespace: purl

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vector
rules:
  - apiGroups: [""]
    resources: ["pods", "namespaces", "nodes"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vector
subjects:
  - kind: ServiceAccount
    name: vector
    namespace: purl
