# =============================================================================
# Vector Configuration for REMOTE Servers
# =============================================================================
# Bu config boshqa serverlarga o'rnatiladi
# Loglarni markaziy Purl serverga yuboradi
#
# O'rnatish:
#   1. Vector o'rnating: curl -sSL https://sh.vector.dev | bash
#   2. Bu faylni /etc/vector/vector.toml ga ko'chiring
#   3. Environment variables sozlang (pastda ko'rsatilgan)
#   4. systemctl enable --now vector
# =============================================================================

data_dir = "/var/lib/vector"

[api]
enabled = true
address = "0.0.0.0:8686"

# =============================================================================
# SOURCES - Log Manbalar
# =============================================================================

# Docker container logs
[sources.docker_logs]
type = "docker_logs"
docker_host = "unix:///var/run/docker.sock"
exclude_containers = ["vector", "*-vector"]

# Journald/Systemd logs
[sources.journald]
type = "journald"
current_boot_only = true
exclude_units = ["vector.service"]

# File-based logs (optional - uncomment if needed)
# [sources.file_logs]
# type = "file"
# include = [
#     "/var/log/syslog",
#     "/var/log/auth.log",
#     "/var/log/nginx/*.log",
#     "/var/log/apache2/*.log",
# ]
# ignore_older_secs = 86400

# =============================================================================
# TRANSFORMS - Log Processing
# =============================================================================

# Docker logs transformation
[transforms.docker_transform]
type = "remap"
inputs = ["docker_logs"]
source = '''
# Server hostname
.host = get_env_var("VECTOR_HOSTNAME") ?? get_hostname!()

# Container name -> service
container = string!(.container_name)
.service = replace(container, r'^/', "")

# Log level detection
msg = string(.message) ?? ""
level = "INFO"

if match(msg, r'(?i)\b(fatal|panic|critical)\b') {
    level = "FATAL"
} else if match(msg, r'(?i)\b(error|err|exception|failed)\b') {
    level = "ERROR"
} else if match(msg, r'(?i)\b(warn|warning)\b') {
    level = "WARN"
} else if match(msg, r'(?i)\b(debug|trace)\b') {
    level = "DEBUG"
}

.level = level
.raw = msg

# Metadata
.meta = encode_json({
    "container_id": string(.container_id) ?? "",
    "image": string(.image) ?? "",
    "source": "docker",
    "server": .host
})

# Cleanup
del(.container_id)
del(.container_name)
del(.image)
del(.stream)
del(.source_type)
del(.label)
'''

# Journald logs transformation
[transforms.journald_transform]
type = "remap"
inputs = ["journald"]
source = '''
.host = get_env_var("VECTOR_HOSTNAME") ?? get_hostname!()

# Service name from unit
unit = string(._SYSTEMD_UNIT) ?? string(.SYSLOG_IDENTIFIER) ?? "systemd"
.service = replace(unit, r'\.service$', "")

# Syslog priority to level
priority = to_int(.PRIORITY) ?? 6
if priority <= 2 {
    .level = "FATAL"
} else if priority <= 3 {
    .level = "ERROR"
} else if priority == 4 {
    .level = "WARN"
} else if priority >= 7 {
    .level = "DEBUG"
} else {
    .level = "INFO"
}

msg = string(.message) ?? ""
.raw = msg

.meta = encode_json({
    "pid": string(._PID) ?? "",
    "source": "journald",
    "server": .host
})

# Cleanup journald fields
del(._SYSTEMD_UNIT)
del(.SYSLOG_IDENTIFIER)
del(.PRIORITY)
del(._PID)
del(._UID)
del(._GID)
del(._COMM)
del(._EXE)
del(._CMDLINE)
del(._CAP_EFFECTIVE)
del(._SELINUX_CONTEXT)
del(._AUDIT_SESSION)
del(._AUDIT_LOGINUID)
del(._MACHINE_ID)
del(._HOSTNAME)
del(._TRANSPORT)
del(._STREAM_ID)
del(.source_type)
'''

# Merge all sources
[transforms.merged]
type = "remap"
inputs = ["docker_transform", "journald_transform"]
source = '''
# Ensure required fields
.timestamp = .timestamp ?? now()
.level = .level ?? "INFO"
.service = .service ?? "unknown"
.host = .host ?? get_hostname!()
.message = .message ?? ""
.raw = .raw ?? .message
'''

# Filter empty messages
[transforms.filtered]
type = "filter"
inputs = ["merged"]
condition = 'length(string!(.message)) > 0'

# =============================================================================
# SINK - Send to Purl API
# =============================================================================

[sinks.purl_api]
type = "http"
inputs = ["filtered"]
uri = "${PURL_URL}/api/logs"
method = "post"
compression = "gzip"

[sinks.purl_api.encoding]
codec = "json"

[sinks.purl_api.batch]
max_bytes = 1048576
max_events = 100
timeout_secs = 5

[sinks.purl_api.buffer]
type = "disk"
max_size = 268435488  # 256MB - survives restarts
when_full = "block"

[sinks.purl_api.request]
concurrency = 10
timeout_secs = 30
rate_limit_duration_secs = 1
rate_limit_num = 100
retry_initial_backoff_secs = 1
retry_max_duration_secs = 300
headers.Content-Type = "application/json"
headers.X-API-Key = "${PURL_API_KEY}"

[sinks.purl_api.healthcheck]
enabled = true

# =============================================================================
# METRICS (optional)
# =============================================================================

[sources.internal_metrics]
type = "internal_metrics"
scrape_interval_secs = 30

[sinks.prometheus]
type = "prometheus_exporter"
inputs = ["internal_metrics"]
address = "0.0.0.0:9598"
default_namespace = "vector"

# =============================================================================
# O'RNATISH QO'LLANMASI
# =============================================================================
#
# 1. Vector o'rnating:
#    curl -sSL https://sh.vector.dev | bash
#
# 2. Environment variables fayliga qo'shing:
#    sudo tee /etc/default/vector > /dev/null << 'EOF'
#    PURL_URL=http://your-purl-server:3000
#    PURL_API_KEY=your-api-key-here
#    VECTOR_HOSTNAME=server-name
#    EOF
#
# 3. Config ni ko'chiring:
#    sudo cp vector-remote.toml /etc/vector/vector.toml
#
# 4. Vector ni ishga tushiring:
#    sudo systemctl enable --now vector
#
# 5. Test qiling:
#    curl -s http://localhost:8686/health
#    journalctl -u vector -f
#
# =============================================================================
# TEKSHIRISH
# =============================================================================
#
# Vector ishlayaptimi:
#    systemctl status vector
#
# Loglar yuborilayaptimi:
#    curl -s http://localhost:8686/health | jq
#
# Purl serverda ko'rish:
#    curl -H "X-API-Key: your-key" http://your-purl-server:3000/api/logs
#
# =============================================================================
