# Vector configuration for Purl
# Collects logs from various sources and sends to ClickHouse

# ============================================================
# Sources
# ============================================================

# Docker container logs
[sources.docker_logs]
type = "docker_logs"
docker_host = "unix:///var/run/docker.sock"
exclude_containers = ["purl-vector", "purl-clickhouse"]

# Syslog listener
[sources.syslog]
type = "syslog"
address = "0.0.0.0:514"
mode = "udp"

# File-based logs
[sources.nginx_access]
type = "file"
include = ["/var/log/nginx/access.log"]
read_from = "end"

[sources.nginx_error]
type = "file"
include = ["/var/log/nginx/error.log"]
read_from = "end"

[sources.syslog_file]
type = "file"
include = ["/var/log/syslog", "/var/log/messages"]
read_from = "end"

# ============================================================
# Transforms
# ============================================================

# Parse Docker logs
[transforms.parse_docker]
type = "remap"
inputs = ["docker_logs"]
source = '''
.service = .container_name
.host = .host
.level = "INFO"
.raw = .message

# Try to parse JSON
parsed, err = parse_json(.message)
if err == null {
    .message = parsed.message ?? parsed.msg ?? parsed.log ?? .message
    .level = upcase(parsed.level ?? parsed.severity ?? "INFO")
    .timestamp = parsed.timestamp ?? parsed.time ?? parsed["@timestamp"] ?? now()
} else {
    .timestamp = now()
}
'''

# Parse nginx access logs
[transforms.parse_nginx_access]
type = "remap"
inputs = ["nginx_access"]
source = '''
.service = "nginx"
.level = "INFO"
.raw = .message

# Parse nginx combined format
parsed, err = parse_nginx_log(.message, "combined")
if err == null {
    .message = to_string(parsed.request) + " " + to_string(parsed.status) + " " + to_string(parsed.size)
    .host = parsed.host
    .meta = {
        "remote_ip": parsed.client,
        "method": parsed.method,
        "path": parsed.path,
        "status": parsed.status,
        "bytes": parsed.size,
        "user_agent": parsed.agent,
        "referrer": parsed.referer
    }

    # Set level based on status code
    status = to_int(parsed.status) ?? 200
    if status >= 500 {
        .level = "ERROR"
    } else if status >= 400 {
        .level = "WARNING"
    }
}

.timestamp = now()
'''

# Parse nginx error logs
[transforms.parse_nginx_error]
type = "remap"
inputs = ["nginx_error"]
source = '''
.service = "nginx"
.raw = .message
.timestamp = now()

# Parse nginx error format: 2024/12/10 10:23:45 [error] 1234#5678: message
parsed, err = parse_regex(.message, r'^(?P<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<pid>\d+)#(?P<tid>\d+): (?:\*(?P<cid>\d+) )?(?P<msg>.*)$')
if err == null {
    .level = upcase(parsed.level)
    .message = parsed.msg
    .meta = {
        "pid": parsed.pid,
        "tid": parsed.tid
    }
}
'''

# Parse syslog
[transforms.parse_syslog]
type = "remap"
inputs = ["syslog", "syslog_file"]
source = '''
.raw = .message
.service = .appname ?? "syslog"
.host = .hostname ?? .host

# Map syslog severity to level
severity = to_int(.severity) ?? 6
if severity <= 2 {
    .level = "CRITICAL"
} else if severity == 3 {
    .level = "ERROR"
} else if severity == 4 {
    .level = "WARNING"
} else if severity == 5 {
    .level = "NOTICE"
} else if severity == 6 {
    .level = "INFO"
} else {
    .level = "DEBUG"
}

.timestamp = .timestamp ?? now()
'''

# ============================================================
# Sinks
# ============================================================

# Send to ClickHouse
[sinks.clickhouse]
type = "clickhouse"
inputs = ["parse_docker", "parse_nginx_access", "parse_nginx_error", "parse_syslog"]
endpoint = "http://clickhouse:8123"
database = "purl"
table = "logs"
skip_unknown_fields = true

# Table schema mapping
[sinks.clickhouse.encoding]
timestamp_format = "rfc3339"

# Batch settings
[sinks.clickhouse.batch]
max_bytes = 10485760
max_events = 10000
timeout_secs = 5

# Buffer settings
[sinks.clickhouse.buffer]
type = "disk"
max_size = 268435488
when_full = "block"

# ============================================================
# Healthcheck
# ============================================================

[sinks.console_debug]
type = "console"
inputs = []
encoding.codec = "json"
